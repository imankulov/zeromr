#!/usr/bin/env python
# -*- coding: utf-8 -*-
from multiprocessing import Process
from zeromr.worker import Worker
from zeromr.binutils import get_argument_parser, setup_logger


def main():
    parser = get_argument_parser()
    parser.add_argument('-s', '--sender-socket', default='tcp://*:5555')
    parser.add_argument('-p', '--processes', default=1, type=int)
    args = parser.parse_args()
    setup_logger(args)
    if args.processes == 1:
        start_worker(args.sender_socket)
    else:
        processes = []
        for _ in xrange(args.processes):
            processes.append(Process(target=start_worker,
                              args=[args.sender_socket]))
        for proc in processes:
            proc.start()
        for proc in processes:
            proc.join()

def start_worker(sender_socket):
    node = Worker(sender_socket=sender_socket)
    print('Starting worker node: {0}'.format(node.name))
    node.start()


if __name__ == '__main__':
    main()
